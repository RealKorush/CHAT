<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat Display</title>
    <style>
        body {
            background-color: #00FF00; /* رنگ سبز خالص برای Chroma Key (پرده سبز) */
            margin: 0;
            overflow: hidden; /* جلوگیری از اسکرول */
            display: flex;
            flex-direction: column-reverse; /* چت‌های جدید از پایین اضافه میشن */
            align-items: flex-start; /* چت‌ها از سمت چپ شروع میشن */
            height: 100vh; /* تمام ارتفاع صفحه */
            padding: 20px; /* فاصله از اطراف */
            box-sizing: border-box; /* padding شامل عرض و ارتفاع میشه */
        }
        .chat-message {
            background-color: rgba(255, 255, 255, 0.85); /* پس‌زمینه سفید کمی شفاف برای چت */
            color: #333; /* رنگ متن */
            padding: 10px 15px;
            margin-bottom: 10px; /* فاصله بین چت‌ها */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 24px; /* اندازه فونت بزرگتر برای استریم */
            max-width: 90%; /* حداکثر عرض پیام */
            word-wrap: break-word; /* شکستن کلمات طولانی */
            direction: rtl; /* راست چین برای متن فارسی */
            text-align: right; /* راست چین برای متن فارسی */
            animation: fadeIn 0.5s ease-out; /* انیمیشن ورود */
        }

        /* انیمیشن محو شدن برای چت‌های قدیمی */
        .chat-message.fade-out {
            animation: fadeOut 1s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateY(-20px); }
        }
        
        /* برای تست: اگر خواستید آیکون‌ها بزرگتر باشن */
        .chat-message span {
            font-size: 1.2em; /* آیکون کمی بزرگتر از متن */
        }
    </style>
</head>
<body>
    <div id="chat-container">
        </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const maxChats = 10; // حداکثر تعداد چت‌های قابل نمایش همزمان

        let lastChats = []; // برای ردیابی چت‌های قبلی

        async function fetchChats() {
            try {
                const response = await fetch('/get_latest_chats'); // درخواست به سرور پایتون برای دریافت چت‌ها
                const data = await response.json();
                const newChats = data.chats; // لیست چت‌های جدید از سرور

                // بررسی برای اضافه کردن چت‌های واقعاً جدید
                // این منطق باید بهبود پیدا کند تا چت‌های تکراری را فیلتر کند
                // فعلاً فقط چت‌های جدیدی که در lastChats نبودند را اضافه می‌کند
                
                const currentDisplayChats = Array.from(chatContainer.children).map(el => el.innerHTML);

                newChats.forEach(chatText => {
                    if (!currentDisplayChats.includes(chatText)) {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('chat-message');
                        messageElement.innerHTML = chatText; // innerHTML برای نمایش bold و ایموجی
                        chatContainer.prepend(messageElement); // اضافه کردن به بالای لیست (تا با flex-direction: column-reverse درست نمایش داده شه)

                        // مدیریت حداکثر تعداد چت‌ها
                        while (chatContainer.children.length > maxChats) {
                            const lastChild = chatContainer.lastElementChild;
                            lastChild.classList.add('fade-out'); // اضافه کردن کلاس محو شدن
                            lastChild.addEventListener('animationend', () => {
                                lastChild.remove(); // بعد از اتمام انیمیشن، حذف کنید
                            }, { once: true });
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching chats:', error);
            }
        }

        // هر 2 ثانیه یک بار چت‌ها رو به‌روزرسانی کن (باید با زمان fetch در app.py هماهنگ باشه)
        setInterval(fetchChats, 2000); 

        // اولین بار هم بعد از بارگذاری صفحه چت‌ها رو بگیر
        fetchChats();
    </script>
</body>
</html>
